#+title: bravli Development Log
#+subtitle: Where we are, where we've been, where we're going
#+startup: showall

* Where We Are <2026-02-19 Wed>

** The Project

=bravli= (Brain Reconstruction Analysis and Validation Library) is a literate,
LLM-assisted toolkit for exploring the /Drosophila/ whole-brain connectome.
It inherits ideas from three sources:

- *Blue Brain Project heritage* (~/work/bbp/work/): the =KnowledgeBench= dataset
  abstraction, =BrainParcellation= domain model, =Factology= structured
  measurement system, and the sparse-to-dense atlas pipeline methodology.

- *MayaDevGenI philosophy*: understanding through creation, literate programming
  as single source of truth, dual human-machine audience.

- *FlyWire connectome* (2024): 139,255 neurons, 54.5M synapses, 8,453 cell types,
  neurotransmitter predictions, all publicly available. The complete wiring
  diagram of an adult fly brain that runs on a laptop.

The key insight: for the fly brain, BBP's pipeline is /inverted/. Where BBP
spent years building anatomy from sparse data (stages 1-7), for Drosophila
the anatomy is given. The frontier is understanding, simulation, and
exploration.

** What Exists

*** Code (Python package: =bravli/=)
| Module            | Status | What it does                                      |
|-------------------+--------+---------------------------------------------------|
| =bench/=          | Done   | Dataset loading, validation, =@evaluate_datasets= |
| =parcellation/=   | Done   | Neuropil parcellation, FlyWire loader              |
| =composition/=    | Done   | Cell type composition per neuropil                 |
| =factology/=      | Done   | Structured facts (=Fact=, =Factology= ABC)        |
| =viz/=            | Done   | 3D visualization (navis + plotly)                  |
| =explore/=        | Done   | Mushroom body deep dive                            |
| =atlas/=          | Done   | Neuropil meshes + skeleton rendering               |
| =connectivity/=   | Done    | Edge list loading, neuropil matrices, pathways     |
| =physiology/=     | Done    | Synapse models, NT-to-biophysics DB, assignment    |
| =models/=         | Done    | Cell electrical models (LIF, graded, CellModelDB) |
| =simulation/=     | Done    | Pure-numpy LIF engine, circuit assembly, analysis |
| =portal/=         | Done    | Interactive digital twin exploration (Panel)       |

*** Literate Source (=codev/=)
Each lesson is an Org file that teaches the science /and/ specifies the code.
Source files are tangled from these.

| Lesson | File                          | Topic                                    |
|--------+-------------------------------+------------------------------------------|
|     00 | =00-foundations.org=          | Datasets, logging, benchmarks            |
|     01 | =01-parcellation.org=         | 78 neuropils from FlyWire                |
|     02 | =02-composition.org=          | Cell type counts per neuropil            |
|     03 | =03-factology.org=            | Structured measurement framework         |
|     04 | =04-visualization.org=        | 3D viz with navis + plotly               |
|     05 | =05-explore-mushroom-body.org= | MB deep dive: KCs, MBONs, DANs         |
|     06 | =06-atlas.org=                | Neuropil meshes + skeleton morphologies  |
|     07 | =07-plan-fly-brain-2026.org=  | Roadmap: BBP pipeline mapped to fly      |
|     08 | =08-connectivity.org=         | Edge list, neuropil matrices, pathways   |
|     09 | =09-synaptic-physiology.org=  | NT-to-biophysics synapse parameter DB    |
|     10 | =10-cell-models.org=          | LIF + graded point neuron models         |
|     11 | =11-simulation.org=           | Whole-brain LIF simulation engine        |
|     12 | =12-portal.org=               | Interactive digital twin portal          |

*** Data (=data/=, not committed)
| Asset                                      | Size  | Auth needed? |
|--------------------------------------------+-------+--------------|
| =flywire_annotations/= (139K neuron TSV)   | 32 MB | No           |
| =zenodo/sk_lod1_783_healed_ds2.parquet=    | 5.1 GB | No          |
| =zenodo/proofread_connections_783.feather=  | 852 MB | No          |
| Neuropil meshes (78 PLY, via =fafbseg=)    | ~1 MB | No (bundled) |

*** Outputs (=output/=, not committed)
10 interactive 3D HTML visualizations (~100 MB total), including:
- =whole_brain_atlas_78_neuropils.html= --- all 78 neuropil meshes
- =mb_skeletons_in_atlas.html= --- 55 neuron skeletons inside MB compartments
- =whole_brain_atlas_with_neurons.html= --- full atlas + neuron morphologies

*** Tests (=tests/=)
12 test files covering all modules (160 tests). Tests that require the Zenodo parquet or
=fafbseg= are conditionally skipped.

** Origin Story

This project grew from an overnight session (2026-02-18/19) exploring the
unfinished =ExploreBlueBrainAtlas= repo (=~/work/bbp/work/MMB/atlas/BBA/=).
That repo contained:

1. A =KnowledgeBench= --- filesystem-backed dataset registry with typed
   datasets, lazy evaluation, and NEXUS integration
2. A =BrainParcellation= --- recursive domain model for AIBS ontology +
   annotation volumes
3. Reverse-engineered BBP atlas pipeline documentation
4. Composition engine wrapping =atlas-densities=
5. CCFv2/v3 transplant logic

The conclusion: the scientific logic is timeless, but the BBP infrastructure
(NEXUS, GPFS, Slurm) is dead. The fly brain provides the same intellectual
challenge with none of the infrastructure burden.

Transcripts of the session are at:
- =~/work/bbp/work/MMB/atlas/BBA/ExploreBlueBrainAtlas/.agent-shell/transcripts/2026-02-18-20-34-35.md=

** Roadmap (from =codev/07-plan-fly-brain-2026.org=)

| Phase | Description               | Status  | Key deliverable                        |
|-------+---------------------------+---------+----------------------------------------|
|     0 | Foundation (lessons 00-06) | Done    | 3D atlas, factsheets, tests            |
|     1 | Connectivity analysis      | Done    | Edge list, neuropil matrix, pathways   |
|     2 | Synaptic physiology        | Done    | Per-NT synapse models + assignment      |
|     3 | Cell electrical models     | Done    | LIF/graded models per cell type class  |
|     4 | Circuit simulation         | Done    | Pure-numpy LIF engine on laptop        |
|     5 | Digital twin portal        | Done    | Panel-based interactive exploration     |
|     6 | WebGPU visualization       | Future  | MayaPortal integration                 |

** Immediate Next Steps

1. [X] Initialize git repo, make initial commit
2. [X] Write =codev/08-connectivity.org= --- edge list loading, neuropil
   connectivity matrix, pathway analysis, NT classification
3. [X] Acquire synapse data (Zenodo feather, 852 MB, auth-free)
4. [X] Build =bravli/connectivity/= module (edges, matrix, pathways)
5. [X] Write =codev/09-synaptic-physiology.org=
6. [X] Build =bravli/physiology/= module (synapse_models, assign)
7. [X] Write =codev/10-cell-models.org=
8. [X] Build =bravli/models/= module

** Dependencies

#+begin_src text
Python 3.12
Core:     numpy, pandas, pyyaml, matplotlib
FlyWire:  navis >= 1.0, fafbseg >= 3.0
Viz:      plotly >= 5.0
Future:   brian2 (simulation), networkx/graph-tool (connectivity)
#+end_src

** How to Run

#+begin_src bash
cd ~/Darshan/research/develop/agentic/mayalucia/bravli/code/bravli
pip install -e ".[all]"
pytest tests/ -v
#+end_src

** Relationship to MayaLucIA

=bravli= lives under =mayalucia/bravli/code/bravli/= but is being initialized
as its own git repository. It is the neuroscience arm of MayaLucIA --- the
concrete domain (fly brain) where the Measure-Model-Manifest-Evaluate cycle
is applied. MayaPortal will eventually provide the rendering backend.

* Log

** <2026-02-18 Tue> Session: BBA archaeology + fly brain pivot
- Explored =ExploreBlueBrainAtlas= repo, identified reusable assets
- Discussed with Claude Code: three options (library, docs, dataset abstraction)
- Pivoted to fly brain --- complete FlyWire connectome, no infra needed
- Drafted Phase 1 plan for =bravli=
- Downloaded FlyWire annotations, Zenodo skeletons (5.1 GB)
- Built 10 interactive 3D visualizations
- Wrote lessons 00-07 in =codev/=
- All code tangled, tests passing

** <2026-02-19 Wed> Repository initialization
- Created =develop/devlog.org= (this file)
- Initialized git repository
- Initial commit: Phase 0 complete

** <2026-02-19 Wed> Phase 2 — Synaptic physiology
- Built =bravli/physiology/= module:
  - =synapse_models.py=: SynapseModel + STPParams frozen dataclasses,
    SYNAPSE_DB with all 6 NT types, confidence annotations
  - =assign.py=: assign biophysical or Shiu-mode parameters to edges,
    compute synaptic weights, physiology summary
- Parameter sources:
  - ACh (HIGH): Su & O'Dowd 2003, Lee & O'Dowd 2000 — Kenyon cell nAChR
  - GABA (HIGH): Lee et al. 2003 — Rdl GABA_A fast inhibition
  - Glutamate (LOW): GluCl kinetics inferred from GABA_A analogy
  - Aminergic (MEDIUM): modulatory, modeled as gain modulation
  - Shiu et al. 2024: reference LIF params (tau_syn=5ms, W_syn=0.275mV)
- Wrote =codev/09-synaptic-physiology.org= — literate lesson
- 20 new tests, all passing (105 total, 2 skipped)

** <2026-02-19 Wed> Phase 5 — Digital twin portal
- Built =bravli/portal/= module (Panel framework):
  - =views.py=: Five reactive view builders — atlas, composition, connectivity,
    physiology, simulate — each returning composable Panel layouts
  - =app.py=: =build_portal()= assembles tabs, auto-discovers annotation data
- Five methodology-mirroring tabs (BBP portal pattern):
  1. Atlas: neuropil highlighting, region selector, 3D placeholder
  2. Composition: group-by selector, bar chart, NT pie, cell type table
  3. Connectivity: neuropil filter, synapse histogram, NT breakdown, top pathways
  4. Physiology: synapse model DB table, E/I weight distribution
  5. Simulate: duration/stimulus controls, run button, raster + rate + V traces
- Pedagogical design: provocative marginalia in every tab — questions, not answers
- Demo circuit (100 neurons, 80E/20I) as fallback when no data loaded
- Wrote =codev/12-portal.org= — literate lesson on portal design philosophy
- 11 new tests, all passing (160 total, 2 skipped)
- New dependency: panel >= 1.0 (+ bokeh, plotly)

** <2026-02-19 Wed> Phase 4 — Circuit simulation
- Built =bravli/simulation/= module (pure numpy, zero new dependencies):
  - =circuit.py=: Circuit dataclass, build_circuit from bravli pipeline,
    build_circuit_from_edges for quick Shiu-style assembly
  - =engine.py=: Vectorized LIF with Euler integration, heterogeneous per-neuron
    parameters, circular delay buffer, np.add.at spike delivery
  - =stimulus.py=: Poisson, step, pulse protocols with provenance tracking
  - =analysis.py=: firing_rates, spike_raster, ei_balance, active_fraction,
    population_rate
- Key design: no Brian2 dependency — the Feynman imperative. LIF core is ~30 lines.
  Shiu achieved ~5 min/s with Brian2+C++; we estimate ~10-30 min/s in numpy.
- Fixed delay buffer bug: clear-after-read, not clear-on-write
- Zhang et al. 2024 (iScience) confirms network topology dominates over
  neuron model choice — LIF vs Izhikevich vs sigmoid produce same patterns
- Wrote =codev/11-simulation.org= — literate lesson
- 23 new tests, all passing (149 total, 2 skipped)

** <2026-02-19 Wed> Phase 3 — Cell electrical models
- Built =bravli/models/= module:
  - =cell_models.py=: LIFParams + GradedParams frozen dataclasses,
    CellModelDB registry with cell_class > super_class > default resolution
  - =assign.py=: assign cell models (uniform or class-aware), population summary
- 12 registered models:
  - Spiking: default_spiking, shiu_uniform, projection_neuron (HIGH),
    kenyon_cell (HIGH), motoneuron_fast/slow (HIGH), clock_neuron (MEDIUM),
    central_default, motor_default, sensory_default
  - Graded: optic_graded (LOW), photoreceptor (MEDIUM)
- Key design: graded neurons = LIF with unreachable threshold (+100 mV),
  following Stolz et al. 2021 approach
- Wrote =codev/10-cell-models.org= — literate lesson
- 21 new tests, all passing (126 total, 2 skipped)

** <2026-02-19 Wed> Phase 1 — Connectivity analysis
- Downloaded =proofread_connections_783.feather= from Zenodo (852 MB, auth-free)
  - 16.8M edges, 138K neurons, 79 neuropils
  - Columns: pre/post root ID, neuropil, syn_count, 6 NT probability averages
- Wrote =codev/08-connectivity.org= — literate lesson on connectome analysis
- Built =bravli/connectivity/= module:
  - =edges.py=: load, threshold ($\geq 5$ syn), assign dominant NT, aggregate
  - =matrix.py=: neuropil synapse counts, 79×79 connectivity matrix, NT matrices
  - =pathways.py=: pathway stats, top connections, convergence/divergence, NT breakdown
- 22 new tests, all passing (85 total, 2 skipped)
- Added =pyarrow= and =scipy= to dependencies

* Local variables :noexport:
# Local Variables:
# org-confirm-babel-evaluate: nil
# End:
